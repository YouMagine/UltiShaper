<html>
<head>
  <meta charset="utf-8">
  <title>UltiCreator Blocks</title>
  <script type="text/javascript" src="assets/js/localization.js"></script>
  <script type="text/javascript">
// default lang:
LANG = LANG_EN_EN;

var cursor_rot=[0,0,0];
var cursor_trans=[0,0,0];
var myVarNames = [];
var myVarValues = [];
var colors = {selected:[0.6,0.5,0.2]};

var inputFields = [];
var inputFieldValues = [];



</script>
  <script type="text/javascript" src="lib/blockly/blockly_compressed.js"></script>
  <script type="text/javascript" src="assets/js/history.js"></script><!-- Undo/Redo -->
  <script type="text/javascript" src="assets/js/cli.js"></script><!-- Undo/Redo -->
  <script type="text/javascript" src="lib/blockly/language/en/_messages.js"></script>
  <script type="text/javascript" src="lib/blockly/language/common/math.js"></script>
<!--  <script type="text/javascript" src="lib/blockly/language/common/logic.js"></script>-->
<!--  <script type="text/javascript" src="lib/blockly/language/common/control.js"></script>-->
<!--  <script type="text/javascript" src="lib/blockly/language/common/lists.js"></script>-->
<!--  <script type="text/javascript" src="lib/blockly/language/common/procedures.js"></script>-->
  <script type="text/javascript" src="lib/blockly/language/common/text.js"></script>
  <script type="text/javascript" src="lib/blockly/language/common/variables.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/math.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/shapes.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/cursor.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/polygons.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/inputfields.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/vars.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<!-- CoffeeSCAD -->
  <script data-main="lib/CoffeeSCad/app/config" src="lib/CoffeeSCad/assets/js/libs/require.min.js"></script>
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/bootstrap.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/font-awesome.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/codemirror.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/backbone.forms.default.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/backbone.forms.bootstrap.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/custom-theme/jquery-ui-1.9.0.custom.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/editor.css">
<!-- /CoffeeSCAD -->
<!-- sliders -->
<script type="text/javascript" src="lib/blockly/common.js"></script>
<!-- /sliders -->  
<script type="text/javascript">


// var codeLanguage = 'scad';
var codeLanguage = 'vol0.1';
var storageApiEndpoint = '/shapes/';
var autoSave = false;
var autoSaveInitial = true;
var autoSaveInterval = 2000;
var app;
var prevXML = '';


/**
 * Initialize Blockly
 */
function init() {
  if(typeof initCli == 'function')
    initCli();
  else console.log("couldn't load CLI.");

  $("#blockly").draggable({ handle: "h5" });
  $("#blockly h5").css({ cursor: "hand" });
  // var toolbox = '<xml>';
  //   toolbox += '  <block type="controls_if"></block>';
  //   toolbox += '  <block type="controls_repeat"></block>';
  //   toolbox += '</xml>';
  // var toolbox = document.getElementById('toolbox');
  var keepers = 'shape_cube,shape_cylinder,shape_sphere,assembly_part,math_number,math_arithmetic'.split(',');
  // Whitelist of blocks to keep.
  var newLanguage = {};
  for (var x = 0; x < keepers.length; x++) {
    newLanguage[keepers[x]] = Blockly.Language[keepers[x]];
  }
  // Blockly.Language = newLanguage;

  var startBlocks = $('#startBlocks').html();

  Blockly.inject(document.getElementById('svgDiv'),{
    path: '../../', toolbox: '<xml><block type="math_number"><title name="NUM">30</title></block></xml>' //document.getElementById('toolbox')
  });
//alert(startBlocks);
  // Load the editor with a starting block.
  // console.log("loading ",startBlocks);
  var xml = Blockly.Xml.textToDom("<xml>"+startBlocks+"</xml>");
  // ERIK: removed seats block.
  Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
  // seatsBlock = Blockly.mainWorkspace.getTopBlocks(false)[0];
  Blockly.addChangeListener(myUpdateFunction);
  Blockly.bindEvent_(Blockly.mainWorkspace.getCanvas(),
        'blocklySelectChange', null, function() {setTimeout(myUpdateFunction,1)});
  // window.onbeforeunload = function() {
   // return 'Leaving this page will result in the loss of your work.';
  // };
  window.setTimeout(function(){
//  loadCode(true);
  $('#inputPane').hide();

    myUpdateFunction();
    $('div.ui-dialog a.ui-dialog-titlebar-close').click();// close all other windows.
  }, 1500);
  window.setInterval(doAutoSave,autoSaveInterval);
  loadMatches('shapes'); // load defines, etc.

} // end of function init

function createBlockAtCursor(xmlStr){
  try {
    var xml = Blockly.Xml.textToDom(xmlStr);      
    console.log(Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml));
  } catch(err){

  }
}


var numUpdates = 0;
function myUpdateFunction() {
  // console.log('myUpdateFunction() ran '+(numUpdates++)+' times');
  var xml = getXML();

  if(typeof hist !='undefined') hist.addEntry(xml);

  var langDropbox = document.getElementById("lang");
  cursor_rot=[0,0,0];
  cursor_move=[0,0,0];
  var myVars;
  codeLanguage = langDropbox.options[langDropbox.selectedIndex].value;
    // if(!codeLanguage) 
    // codeLanguage = 'scad';
    var code;
    if(codeLanguage == 'coffeescad0.1') {
      var variables = Blockly.Variables.allVariables();
      console.log(variables);
      // for (var x = 0; x < variables.length; x++) {
      // console.log(Blockly.JavaScript.variableDB_.getName(variables[x],
          // Blockly.Variables.NAME_TYPE));
      // }
      code = Blockly.Generator.workspaceToCode('JavaScript');
      //Blockly.JavaScript.definitions_['variables'] = defvars.join('\n');
      joinShapesList = code.split(';');
      var pre =''; var post='';
      while(joinShapesList.length > 2) {
        var str = joinShapesList.shift();
        if(str.substring(0,4)=='var ')
          continue; // skip variable assignments
        /* colors.selected */
        // if(joinShapesList.current()=='')
        pre += str.trim()+".union("; post += ")";
      }
      code = pre+joinShapesList.shift().trim()+post;
      code = "# coffeescad0.1\n\nrot=[0,0,0];tr=[0,0,0];\nreturn "+code;
    }
    if (codeLanguage == 'vol0.1') {
      code = '<'+'?xml version="1.0" ?'+'>\n <VOL VersionMajor="1" VersionMinor="2">\n     <Parameters />\n     <uformia.base.Model.20110605 Name="43">';
      code += Blockly.Generator.workspaceToCode('JavaScript');
      
       code += '\n     </uformia.base.Model.20110605>\n </VOL>';
    }
    if(codeLanguage == 'scad') {
      code = Blockly.Generator.workspaceToCode('JavaScript');
      code = "$fs=0.4;\n$fa=5;\n"+code;
    }

    document.getElementById('codearea').value = code;
    if(app && app.loadCode)
      app.loadCode(code);
}

function doAutoSave() {
  var xml = getXML();
  if(xml == prevXML) 
    return; // no change, no save.
  prevXML = xml;
  if(prevXML == '') 
    return; // empty, no save.
  if(autoSave == true) {
    console.log('autosaving... (a change was made)');
    saveCode();
  }
}

function getXML() {
  var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
  var xml_text = Blockly.Xml.domToText(xml);
  return (xml_text);
}
function loadUpXML(xmlData) {
  Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xmlData);
}
function updateDefine(id,name){
  var xml = getXML();
  jQuery.ajax({
    url: '/shapes/'+id+'.json',
    type: 'PUT',
    data: { shape: {name: name, xmldata: xml } },
    success: function(data) {
      alert("" + data);
      }
  });
}

function saveDefine(name){
  var xml = getXML();
  jQuery.ajax({
    url: '/shapes.json',
    type: 'POST',
    data: {shape: {name: name, xmldata: xml } },
    success: function(data) {
      alert("" + data);
      }
  });
}

function saveCode(name,saveType) {
  if(!name)
    name = 'autosave';
  if(!saveType) 
    saveType = 'workspace'; // otherwise, it could be a definition (e.g. define cube)
  console.log("saveCode(name=",name,"saveType=",saveType,")");
  var code = getXML();//Blockly.Generator.workspaceToCode('JavaScript');
  jQuery.post(storageApiEndpoint, { storeData: code, name: name, type: saveType })
.done(function(data) {
  alert("" + data);
});
}

function loadMatches(type) {
  if(!type) 
    type = 'shapes';
  //first load shapes
  jQuery.get('/'+type+'/all.json', { },
    function(data){
      console.log('loadShapes('+type+'):',data);
        try {
          // defines = data.global_defines;
          for(defName in data) {
            console.log('loadShapes('+type+'):',data[defName]);
            matchPhrases[data[defName].name] = data[defName];
          }
        } catch (e) {
          alert("Error loading "+type+" data.");
          return;
        }
      // window.setTimeout('autoSave = '+tmpAutosave+';',1000);
    }, "json");
}

function loadCode(initialLoad,name,loadType) {
      console.log('loadCode()');
  // var tmpAutosave = autoSave;
  // autoSave = false;
  if(!name)
    name = 'autosave';
  if(!loadType) 
    loadType = 'workspace'; // otherwise, it could be a definition (e.g. define cube)
  if(initialLoad) 
    autoSave = autoSaveInitial;
  jQuery.get('/shapes/all.json', { "loadData": "1", type: loadType, name: name },
    function(data){
      console.log(data);
      // Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, data.data);  
      if(loadType == 'workspace') {
        console.log(data.data); 
        try {
          var xml = Blockly.Xml.textToDom(data.data);
        } catch (e) {
          alert("Error loading blocks.");
          return;
        }
        Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
      }
      // window.setTimeout('autoSave = '+tmpAutosave+';',1000);
    }, "json");
}
var defines = {};
function loadInitial() {
  console.log('loadInitial()');
  jQuery.post(storageApiEndpoint, { initialLoad: '1' },
    function(data){
      console.log('loadInitial():',data);
        try {
          // defines = data.global_defines;
          for(defName in data.global_defines) {
            console.log('loadInitial():',defName);
            matchPhrases[defName] = data.global_defines[defName];
          }
          // var xml = Blockly.Xml.textToDom(data.data);
        } catch (e) {
          alert("Error loading initial data.");
          return;
        }
      // window.setTimeout('autoSave = '+tmpAutosave+';',1000);
    }, "json");
}

function changeAutoSave(changeTo) {
  autoSave = (changeTo == '1');
}

/* depricated
function runMe() {
  return false;
  window.LoopTrap = 1000;
  Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if(--window.LoopTrap == 0) throw "Infinite loop.";\n';
  var code = Blockly.Generator.workspaceToCode('JavaScript');
  alert(code);
  Blockly.JavaScript.addReservedWords('code');
  var code = Blockly.Generator.workspaceToCode('JavaScript');
  try {
    eval(code);
  } catch (e) {
    alert(e);
  }
}
*/

function blockIsSelected(block,typeOfCheck) {
  var isSelected = false;
  // if(block.id && Blockly.selected) console.log("checking if block (id="+block.id+",type="+block.type+') is selected (id='+Blockly.selected.id+',type='+Blockly.selected.type+').');
  // if(!typeOfCheck) typeOfCheck = 'direct';
  if(!Blockly.selected) return false; // no selection
  if(Blockly.selected.id == block.id) {
    // console.log("this is the selected block!!!");
    return true;//isSelected = true;
  }
  if(blockIsShape(Blockly.selected) && (block.id != Blockly.selected.id)) // this is not the shape we're looking for...
  {
    // console.log("isShape? "+blockIsShape(block)+" -- not bubbling up, this isn.t the shape we're looking for.");
    return false; // don't bubble up if we have a different shape selected

  }

  if(typeOfCheck == 'bubbletoshape') {
    // console.log({a:"checking if it's a shape, otherwise go to parent.",sel:Blockly.selected});
    var o = Blockly.selected;
    while(o.parentBlock_) { // as long as it has a parent...
      if(blockIsShape(o.parentBlock_)) { // check if it's a shape.
      // console.log('block id '+o.id,' in category',o.parentBlock_.category,o.category == ucfirst(LANG.shape));
      if(block.id == o.parentBlock_.id)
        return true;
      }
      if(blockIsShape(o.parentBlock_)) // it's an unselected shape. Stop looking.
        return false;
      // it's not the chosen one, bubble up one level:
      // console.log('bubbling up a level (not a selected shape)');
      o = o.parentBlock_;
    }
  }
  return isSelected;
}

function blockIsShape (o) {
  if(!o) return false;
  if(o.category && (o.category == ucfirst(LANG.shape))) return true;
  if(o.type && (o.type == "polygons_extrude")) return true;
  if(o.type && (o.type == "assembly_part")) return true;
  return false;
}

function clearWorkspace() {

  // Blockly.mainWorkspace.getTopBlocks(false)[0].dispose();
  // FIXME: shouldn't have to clear twice.
  var n=0;
  while(typeof Blockly.mainWorkspace.getTopBlocks(false) !='undefined') {
    n++;
    if(n>10) 
      break;
    if(typeof Blockly.mainWorkspace.getTopBlocks(false)[0] !='undefined')
      Blockly.mainWorkspace.getTopBlocks(false)[0].dispose();
  }
}

function var_to_number(varStr){
 return (1*varStr.substring(1,varStr.length-1));
}


$(window).resize(function() {
  $('#blockly').css('top',$(window).height()-115);
  $('#blockly').css('height',360);
  $('#blockly').css('left',$(window).width()/2-200);
});

  </script>
  <style>
    body {
      background-color: white;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    #svgDiv {
      height: 300px;
      width: 100%;
      border: 1px solid #ccc;
    }
    .hide {
      display:none;
    }
    #qsResults {
      z-index: 99;
      top: 0px;
      left:0px;
      position: relative;
    }
    .qsItem {
      background-color: white;
      width: 100%;
      cursor: hand;
    }
    .qsSelected {
      color: white;
      background-color: blue;
    }
  </style>
</head>
<body onload="init()">
<div class="container-fluid ui-layout-center">
                <div class="row-fluid">
                        <div class="span12">
                                <div id="navigation">
                                </div>
                                <div id="mainContent" class="row-fluid " >
                                </div>
                        </div>
                </div>
        </div>
        <div id="modal" class="modal hide fade">        
        </div>
        <div id="alertmodal" class="modal hide fade">   </div>
        <div id="dialogRegion">
        </div>

  <div id="blockly" class="modal" style="top:750px;width: 100%;height:300px;">
  <table>
    <tr>
      <td><h5><b>Drag-and-Drop 3D Design</b></h5></td>
      <td><span style="color:grey">(Change your language to: <a href="?l=NL_NL">Nederlands</a>)</span></td>
      <td><div id="quickSearchDiv"><input type='text'></div><div id="qsResults"></div></td>
      <td><a href="#" title="close" onclick="$('#blockly').hide();">x</a></td>
    </tr>
  </table>

  <embed id="inputPane" src="assets/plane.svg" height=90 width=600 type="image/svg+xml"/>
  <div id="svgDiv" style="width: 100%"></div>
  <textarea id="codearea" rows=10 style="width:500px" class="hide"></textarea>
  <table><tr><td>
  <select id="lang" onchange="myUpdateFunction();">
    <option value="coffeescad0.1">CoffeeSCAD</option>
    <option value="vol0.1">Uformia .vol</option>
    <option value="scad">OpenSCAD</option>
  </select>
  <!--<input type="button" onclick="runMe();" value="Run!">-->
  <!--<input type="button" onclick="getXML();" value="Get blocky XML!">-->
  <input type="button" onclick="if(typeof hist !='undefined') hist.undo();" value="Undo">
  <input type="button" onclick="if(typeof hist !='undefined') hist.redo();" value="Redo">
  <input type="button" onclick="saveCode();" value="Save!">
  <input type="button" onclick="loadCode();" value="Load!"><label></td><td><input type="checkbox" onclick="changeAutoSave(this.checked);" value="1" checked> Autosave</label></td></tr></table>
</div>
</body>
</html>
