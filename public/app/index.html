<html>
<head>
  <meta charset="utf-8">
  <title>UltiCreator Blocks</title>
  <script type="text/javascript" src="assets/js/localization.js"></script>
  <script type="text/javascript">
// default lang:
LANG = LANG_EN_EN;

var cursor_rot=[0,0,0];
var cursor_trans=[0,0,0];
var cursor_scale=[1,1,1];
var colors = {selected:[0.6,0.5,0.2],unselected:[124/256,153/256,96/255],limegreen:[122/256,182/256,69/255]};

re = /l=([^&]*)/g;
var urlLang = '';
try
{
  if(location.search)
    urlLang = re.exec(location.search.slice(1))[1];
  else urlLang = 'EN_EN';
  if(urlLang=='NL_NL'){ LANG = LANG_NL_NL;}
  if(urlLang=='EN_EN'){ LANG = LANG_EN_EN;}
  if(urlLang=='DE_DE'){ LANG = LANG_DE_DE;}
} catch (err) {
  console.log('Error trying to detect best language. Defaulting to English.',err);
}
if(typeof urlLang !='string' || urlLang == '') 
  urlLang = 'EN_EN';

</script>
  <script type="text/javascript" src="/translations.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

  <script type="text/javascript" src="lib/blockly/blockly_compressed.js"></script>
  <script type="text/javascript" src="assets/js/utils.js"></script><!-- Various utilities -->
  <script type="text/javascript" src="assets/js/history.js"></script><!-- Undo/Redo -->
  <script type="text/javascript" src="assets/js/cli.js"></script><!-- Command line interface -->
  <script type="text/javascript" src="lib/blockly/language/en/_messages.js"></script>
  <script type="text/javascript" src="lib/blockly/language/common/math.js"></script>
<!--  <script type="text/javascript" src="lib/blockly/language/common/logic.js"></script>-->
<!--  <script type="text/javascript" src="lib/blockly/language/common/control.js"></script>-->
<!--  <script type="text/javascript" src="lib/blockly/language/common/lists.js"></script>-->
<!--  <script type="text/javascript" src="lib/blockly/language/common/procedures.js"></script>-->
  <script type="text/javascript" src="lib/blockly/language/common/text.js"></script>
  <script type="text/javascript" src="lib/blockly/language/common/variables.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/math.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/shapes.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/cursor.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/polygons.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/inputfields.js"></script>
  <script type="text/javascript" src="lib/blockly/generators/javascript/vars.js"></script>
<!-- CoffeeSCAD -->
  <script data-main="lib/CoffeeSCad/app/config" src="lib/CoffeeSCad/assets/js/libs/require.min.js"></script>
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/bootstrap.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/font-awesome.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/codemirror.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/backbone.forms.default.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/backbone.forms.bootstrap.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/custom-theme/jquery-ui-1.9.0.custom.css">
  <link rel="stylesheet" href="lib/CoffeeSCad/assets/css/editor.css">
<!-- /CoffeeSCAD -->
<script type="text/javascript">


// var codeLanguage = 'scad';
var codeLanguage = 'vol0.1';
var storageApiEndpoint = '/shapes.json';
var autoSave = false;
var autoSaveInitial = true;
var autoSaveInterval = 2000;
var app2;
var prevXML = '';

/**
 * Initialize Blockly
 */
function init() {
  if(typeof initCli == 'function')
    initCli();
  else console.log("couldn't load CLI.");
  $("#langDropdown").change(function(o){
    var newLang = $("#langDropdown").val();
    if(newLang == 'NL_NL') if(window.confirm(LANG_NL_NL.switchLangResets)) document.location = "/app?l="+newLang;
    if(newLang == 'EN_EN') if(window.confirm(LANG_EN_EN.switchLangResets)) document.location = "/app?l="+newLang;
    if(newLang == 'DE_DE') if(window.confirm(LANG_DE_DE.switchLangResets)) document.location = "/app?l="+newLang;  
  });
  if(urlLang != '') $("#langDropdown").val(urlLang);

  $("#blockly,#inputModal").draggable({ handle: "h5" });
  // $("#blockly").css({ top: $(window).height() - $("#blockly").height() });
  $("#blockly h5,#inputModal h5").css({ cursor: "hand" });
  $('#qsResults').css({left: $('#quickSearchDiv').position().left,'min-width': $('#quickSearchDiv').width()}
    );
  // var toolbox = '<xml>';
  //   toolbox += '  <block type="controls_if"></block>';
  //   toolbox += '  <block type="controls_repeat"></block>';
  //   toolbox += '</xml>';
  // var toolbox = document.getElementById('toolbox');
  var keepers = 'shape_cube,shape_cylinder,shape_sphere,assembly_part,math_number,math_arithmetic'.split(',');
  // Whitelist of blocks to keep.
  var newLanguage = {};
  for (var x = 0; x < keepers.length; x++) {
    newLanguage[keepers[x]] = Blockly.Language[keepers[x]];
  }
  // Blockly.Language = newLanguage;

  
  Blockly.inject(document.getElementById('svgDiv'),{ path: '../../' });

  Blockly.addChangeListener(myUpdateFunction);
  Blockly.bindEvent_(Blockly.mainWorkspace.getCanvas(),
        'blocklySelectChange', null, function() {setTimeout(myUpdateFunction,1)});
  // window.onbeforeunload = function() {
   // return 'Leaving this page will result in the loss of your work.';
  // };

  window.setTimeout(function(){
  /*$('#inputPane').hide();
    createBlockAtCursor('<xml><block type="shape_sphere" inline="true" x="2" y="-4"><value name="radius"><block type="input_field_slider"><title name="uuid">947be554-7cb9-9736-b2b3-e14c9c4000a2</title><title name="sliderType">horSlider</title><title name="sliderLabel">Sphere size:</title><title name="minVal">30</title><title name="maxVal">150</title><title name="stepIncrement">15</title></block></value></block><block type="cursor_rotate" inline="true" x="1" y="77"><title name="NAME">rotateBy</title><value name="rZ"><block type="input_field_slider"><title name="uuid">2666d1a4-9540-671c-c566-2b056a085ae4</title><title name="sliderType">horSlider</title><title name="sliderLabel">Angle:</title><title name="minVal">0</title><title name="maxVal">360</title><title name="stepIncrement">45</title></block></value><next><block type="shape_cube" inline="true"><title name="CENTEROBJECT">TRUE</title><value name="width"><block type="math_number"><title name="NUM">100</title></block></value><next><block type="cursor_move" inline="true"><title name="NAME">moveBy</title><value name="tX"><block type="math_number"><title name="NUM">50</title></block></value><next><block type="shape_cylinder" inline="true"></block></next></block></next></block></next></block></xml>');
*/
$('#inputPane').hide();

    // createBlockAtCursor('<xml><block type="assembly_part" x="-23" y="-7"><title name="PARTNAME">Ring</title><title name="booleanType">difference</title><statement name="SHAPESADD"><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="math_arithmetic" inline="true"><title name="OP">ADD</title><value name="A"><block type="math_arithmetic" inline="true"><title name="OP">MULTIPLY</title><value name="A"><block type="input_field_slider"><title name="uuid">ad6afb2d-058f-8d51-ae1c-d542da1d5550</title><title name="sliderType">horSlider</title><title name="sliderLabel">Thickness:</title><title name="minVal">1</title><title name="maxVal">6</title><title name="stepIncrement">0.1</title></block></value><value name="B"><block type="math_number"><title name="NUM">2</title></block></value></block></value><value name="B"><block type="input_field_slider"><title name="uuid">be235213-c475-1688-d7b4-1130ce2350c4</title><title name="sliderType">horSlider</title><title name="sliderLabel">Input 1:</title><title name="minVal">0</title><title name="maxVal">20</title><title name="stepIncrement">1</title></block></value></block></value><value name="height"><block type="input_field_slider"><title name="uuid">fdf1de71-6255-447b-030d-ffe3adf49882</title><title name="sliderType">horSlider</title><title name="sliderLabel">Height:</title><title name="minVal">1</title><title name="maxVal">10</title><title name="stepIncrement">0.5</title></block></value></block></statement><statement name="SHAPESREMOVE"><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="input_field_slider"><title name="uuid">be235213-c475-1688-d7b4-1130ce2350c4</title><title name="sliderType">horSlider</title><title name="sliderLabel">Size (mm):</title><title name="minVal">10</title><title name="maxVal">30</title><title name="stepIncrement">1</title></block></value><value name="height"><block type="math_number"><title name="NUM">10</title></block></value></block></statement></block></xml>');

//<xml><block type="assembly_part" x="-11" y="-1"><title name="PARTNAME">Ring</title><title name="booleanType">difference</title><statement name="SHAPESADD"><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="math_arithmetic" inline="true"><title name="OP">ADD</title><value name="A"><block type="math_arithmetic" inline="true"><title name="OP">MULTIPLY</title><value name="A"><block type="input_field_slider"><title name="uuid">ad6afb2d-058f-8d51-ae1c-d542da1d5550</title><title name="sliderType">horSlider</title><title name="sliderLabel">Thickness:</title><title name="minVal">1</title><title name="maxVal">6</title><title name="stepIncrement">0.1</title></block></value><value name="B"><block type="math_number"><title name="NUM">2</title></block></value></block></value><value name="B"><block type="input_field_slider"><title name="uuid">be235213-c475-1688-d7b4-1130ce2350c4</title><title name="sliderType">horSlider</title><title name="sliderLabel">Input 1:</title><title name="minVal">0</title><title name="maxVal">20</title><title name="stepIncrement">1</title></block></value></block></value><value name="height"><block type="math_number"><title name="NUM">15</title></block></value><next><block type="cursor_move" inline="true"><title name="NAME">moveBy</title><value name="tX"><block type="math_number"><title name="NUM">10.5</title></block></value><value name="tY"><block type="math_number"><title name="NUM">-4</title></block></value><value name="tZ"><block type="math_number"><title name="NUM">0</title></block></value><next><block type="shape_cube" inline="true"><title name="CENTEROBJECT">FALSE</title><value name="width"><block type="math_number"><title name="NUM">20</title></block></value><value name="depth"><block type="math_number"><title name="NUM">8</title></block></value><value name="height"><block type="math_number"><title name="NUM">15</title></block></value><next><block type="cursor_move" inline="true"><title name="NAME">moveTo</title></block></next></block></next></block></next></block></statement><statement name="SHAPESREMOVE"><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="input_field_slider"><title name="uuid">be235213-c475-1688-d7b4-1130ce2350c4</title><title name="sliderType">horSlider</title><title name="sliderLabel">Size (mm):</title><title name="minVal">10</title><title name="maxVal">30</title><title name="stepIncrement">1</title></block></value><value name="height"><block type="math_number"><title name="NUM">16</title></block></value><next><block type="cursor_move" inline="true"><title name="NAME">moveBy</title><value name="tX"><block type="math_number"><title name="NUM">10</title></block></value><value name="tY"><block type="math_number"><title name="NUM">-1</title></block></value><value name="tZ"><block type="math_number"><title name="NUM">0</title></block></value><next><block type="shape_cube" inline="true"><title name="CENTEROBJECT">FALSE</title><value name="width"><block type="math_number"><title name="NUM">42</title></block></value><value name="depth"><block type="math_number"><title name="NUM">2</title></block></value><value name="height"><block type="math_number"><title name="NUM">15</title></block></value><next><block type="cursor_move" inline="true"><title name="NAME">moveBy</title><value name="tX"><block type="math_number"><title name="NUM">15</title></block></value><value name="tY"><block type="math_number"><title name="NUM">7.5</title></block></value><value name="tZ"><block type="math_number"><title name="NUM">-10</title></block></value><next><block type="cursor_rotate" inline="true"><title name="NAME">rotateBy</title><value name="rX"><block type="math_number"><title name="NUM">90</title></block></value><next><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="math_number"><title name="NUM">3</title></block></value><value name="height"><block type="math_number"><title name="NUM">30</title></block></value></block></next></block></next></block></next></block></next></block></next></block></statement><next><block type="cursor_rotate" inline="true"><title name="NAME">rotateTo</title><next><block type="cursor_move" inline="true"><title name="NAME">moveTo</title><value name="tX"><block type="math_number"><title name="NUM">-16</title></block></value><value name="tZ"><block type="math_number"><title name="NUM">7.5</title></block></value></block></next></block></next></block><block type="assembly_part" x="-152" y="606"><title name="PARTNAME">Part name 1</title><title name="booleanType">difference</title><statement name="SHAPESADD"><block type="shape_cube" inline="true"><title name="CENTEROBJECT">TRUE</title><value name="width"><block type="math_number"><title name="NUM">6</title></block></value><value name="depth"><block type="math_number"><title name="NUM">76</title></block></value><value name="height"><block type="math_number"><title name="NUM">15</title></block></value></block></statement><statement name="SHAPESREMOVE"><block type="cursor_move" inline="true"><title name="NAME">moveTo</title><value name="tX"><block type="math_number"><title name="NUM">7.5</title></block></value><value name="tY"><block type="math_number"><title name="NUM">30</title></block></value><next><block type="cursor_rotate" inline="true"><title name="NAME">rotateBy</title><value name="rY"><block type="math_number"><title name="NUM">-90</title></block></value><next><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="math_number"><title name="NUM">3</title></block></value><value name="height"><block type="math_number"><title name="NUM">30</title></block></value><next><block type="cursor_move" inline="true"><title name="NAME">moveTo</title><value name="tX"><block type="math_number"><title name="NUM">7.5</title></block></value><value name="tY"><block type="math_number"><title name="NUM">-30</title></block></value><next><block type="shape_cylinder" inline="true"><value name="diameter1"><block type="math_number"><title name="NUM">3</title></block></value><value name="height"><block type="math_number"><title name="NUM">30</title></block></value></block></next></block></next></block></next></block></next></block></statement></block></xml>

    myUpdateFunction();
    $('div.ui-dialog a.ui-dialog-titlebar-close').click();// close all other windows.
  }, 1500);
  window.setInterval(doAutoSave,autoSaveInterval);
  loadMatches('shapes'); // load defines, etc.

} // end of function init

function createBlockAtCursor(xmlStr){
// create block after selection and select that block
// when empty, just paste block:
  if(Blockly.mainWorkspace.getTopBlocks().length == 0)
  {
    try {
      var xml = Blockly.Xml.textToDom(xmlStr);      
      Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
      Blockly.mainWorkspace.getTopBlocks()[0].select();
    } catch(err){

    }  
    return;
  }
// 1. find selection
console.log('createBlockAtCursor('+xmlStr+')');
  var dom = Blockly.Xml.textToDom(xmlStr);
  var domChild = dom.childNodes[0];
  // domChild.setAttribute('x', 0);
  // domChild.setAttribute('y', 0);

  var selectedBlock = Blockly.selected;
  console.log('pre paste');
  //Blockly.selected.workspace.paste(domChild);
  Blockly.mainWorkspace.paste(domChild);
  console.log('after paste');

  if(selectedBlock !== null)
  {
    // xmlStr = '<xml><block type="polygons_extrude" inline="true" x="-10" y="16"><value name="extrudeZ"><block type="math_number"><title name="NUM">20</title></block></value><statement name="shapeToExtrude"><block type="polygons_polygon"><title name="polyName">polyline</title><statement name="pointList"><block type="polygons_point" inline="true"><next><block type="polygons_point" inline="true"><value name="tX"><block type="math_number"><title name="NUM">10</title></block></value><next><block type="polygons_point" inline="true"><value name="tY"><block type="math_number"><title name="NUM">10</title></block></value></block></next></block></next></block></statement></block></statement></block></xml>';
    // xmlStr = '<xml><block type="shape_sphere" inline="true" x="21" y="-15"><value name="radius"><block type="math_number"><title name="NUM">10</title></block></value><next><block type="shape_sphere" inline="true"><value name="radius"><block type="math_number"><title name="NUM">20</title></block></value></block></next></block></xml>';
    // xmlStr = '<xml><block type="shape_sphere" inline="true" x="0" y="0"></block></xml>';
    var topBlocks = Blockly.mainWorkspace.getTopBlocks();
    if(insertBlockBefore == false) {
      if(topBlocks.length > 1) {
        var lastBlockAdded = topBlocks[topBlocks.length-1];
        if(selectedBlock.nextConnection.targetConnection === null) {
          selectedBlock.nextConnection.connect(lastBlockAdded.previousConnection);
        } else {
          console.log("w000t.... complicated stuff.");
          return;
          var secondUpperConnection = selectedBlock.nextConnection.targetConnection;
          secondUpperConnection.disconnect();
          selectedBlock.nextConnection.connect(lastBlockAdded.previousConnection);
          // lastBlockAdded.nextConnection.connect(secondUpperConnection);
          Blockly.fireUiEvent(window, 'resize');
        }
      }
    } else {
      console.log('insertBlockBefore',insertBlockBefore);
      if(topBlocks.length > 1) {
        var lastBlockAdded = topBlocks[topBlocks.length-1];
        if(selectedBlock.previousConnection.targetConnection === null) {
          selectedBlock.previousConnection.connect(lastBlockAdded.nextConnection);
        } else {
          console.log("w000t.... complicated stuff.");
          return;
          // var secondUpperConnection = selectedBlock.nextConnection.targetConnection;
          // secondUpperConnection.disconnect();
          // selectedBlock.nextConnection.connect(lastBlockAdded.previousConnection);
          // lastBlockAdded.nextConnection.connect(secondUpperConnection);
          // Blockly.fireUiEvent(window, 'resize');
        }
      }
    }


// Blockly.mainWorkspace.getTopBlocks()[0].nextConnection.connect(Blockly.mainWorkspace.getTopBlocks()[1].previousConnection)
  // console.log(dom,domChild);
  // // Blockly.selected.workspace.paste(domChild);
  // var workspaceDom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
  // //workspaceDom.appendChild(domChild);
  // var nextBlock = document.createElement("next");
  // nextBlock.appendChild(domChild);
  // // nextBlock;
  // // var lastEl = workspaceDom;
  // var repeatChildStr = '';
  // var repeatChildStr2 = '';
  // var evalStr = 'workspaceDom.lastChild.tagName == "BLOCK";';
  // var n = 0;
  // while(eval(evalStr)) {
  //   n++;
  //   repeatChildStr += '.lastChild.lastChild';
  //   evalStr = 'workspaceDom.lastChild'+repeatChildStr+'.tagName == "BLOCK";';
  //   if(eval(evalStr) == false) {
  //     console.log('false === ',evalStr);
  //     evalStr = 'workspaceDom.lastChild'+repeatChildStr2+'.appendChild(nextBlock);';
  //     console.log(evalStr);
  //     eval(evalStr);
  //     break;
  //   }
  //   repeatChildStr2 += '.lastChild.lastChild';
  //   console.log('next eval: ',evalStr);
  // }

  // //evalStr = 'workspaceDom.lastChild.lastChild.lastChild.tagName == "BLOCK";';
  // console.log(eval(evalStr));
  // while(lastEl.getElementsByTagName('next').length !== 0) { // if there's a next element
  //   console.log('pre',lastEl);
  //   lastEl = lastEl.lastChild.lastChild;
  //   // lastEl = lastEl.lastChild.getElementsByTagName('next')[0].lastChild;
  // }
  // lastEl.appendChild(nextBlock);
  // console.log('post, lastEl: ',lastEl,'workspaceDom',workspaceDom);
  // lastEl.lastChild.getElementsByTagName('next')[0].lastChild.appendChild(nextBlock);
  //workspaceDom.lastChild.appendChild(nextBlock);
  // workspaceDom;
  // console.log(workspaceDom);
  // Blockly.mainWorkspace.clear();
  // Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,lastEl);
}
// 2a inject as child of selection
// 2b inject as child of root? / or  or at cursor?
// 
// var xmlBlock = Blockly.Xml.blockToDom_(block);
// xmlBlock.setAttribute('y', xy.y); 
// Blockly.mainWorkspace.paste(xmlBlock);
// 3. select the next block:
  // Blockly.mainWorkspace.getTopBlocks()[0].getChildren()[0].select()
  // curXML = getXML();
  //Paste the provided block onto the workspace.
  // try {
    // var xml = Blockly.Xml.textToDom(xmlStr);      
    // console.log(Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml));
  // } catch(err){
// 
  // }
  // Blockly.mainWorkspace.paste(xmlStr);
}

var numUpdates = 0;
function myUpdateFunction() {
  // console.log('myUpdateFunction() ran '+(numUpdates++)+' times');
  var xml = getXML();
  if(typeof inputManager === 'object') {
    inputs = inputManager.list();
        for(var i=0;inputs.length > i;i++){
            if(xml.indexOf(this.inputs[i].uuid) === -1) {
                console.log(inputManager.list());
                console.log('Was : ',this.inputs[i], 'removed?');
                $("#input"+this.inputs[i].uuid,planeSvg.document).remove();
                inputs.splice(i,1);
                console.log(inputManager.list());
            }
        }    
  }
  allFields = inputManager.list();
  $('#inputPane').show();
  if(allFields.length > 0) {
      $('#inputModal').show();
  } else {
      $('#inputModal').hide();
  }


  if(typeof hist !='undefined') hist.addEntry(xml);

  var langDropbox = document.getElementById("lang");
  cursor_rot=[0,0,0];
  cursor_move=[0,0,0];
  cursor_scale=[1,1,1];
  var myVars;
  codeLanguage = $('#langDropbox').val();
  if(typeof codeLanguage != 'string') 
    codeLanguage = 'coffeescad0.1';

    var code;
    if(codeLanguage == 'coffeescad0.1') {
      var variables = Blockly.Variables.allVariables();

      code = Blockly.Generator.workspaceToCode('JavaScript');

      joinShapesList = code.split(';');
      var pre =''; var post='';
      while(joinShapesList.length > 2) {
        var str = joinShapesList.shift();
        if(str.substring(0,4)=='var ')
          continue; // skip variable assignments
        /* colors.selected */
        // if(joinShapesList.current()=='')
        pre += str.trim()+".union("; post += ")";
      }
      code = pre+joinShapesList.shift().trim()+post;
      code = "# coffeescad0.1\n\nrot=[0,0,0];tr=[0,0,0];\nreturn "+code;
    }
    if (codeLanguage == 'vol0.1') {
      code = '<'+'?xml version="1.0" ?'+'>\n <VOL VersionMajor="1" VersionMinor="2">\n     <Parameters />\n     <uformia.base.Model.20110605 Name="43">';
      code += Blockly.Generator.workspaceToCode('JavaScript');
      
       code += '\n     </uformia.base.Model.20110605>\n </VOL>';
    }
    if(codeLanguage == 'scad') {
      code = Blockly.Generator.workspaceToCode('JavaScript');
      code = "$fs=0.4;\n$fa=5;\n"+code;
    }
    document.getElementById('codearea').value = code;
    if(app2 && app2.loadCode)
      app2.loadCode(code);
}

function doAutoSave() {
  var xml = getXML();
  if(xml == prevXML) 
    return; // no change, no save.
  prevXML = xml;
  if(prevXML == '') 
    return; // empty, no save.
  if(autoSave == true) {
    console.log('autosaving... (a change was made)');
    saveCode();
  }
}

function getXML() {
  var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
  var xml_text = Blockly.Xml.domToText(xml);
  return (xml_text);
}
function loadUpXML(xmlData) {
  Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xmlData);
}
function updateDefine(id,name){
  var xml = getXML();
  jQuery.ajax({
    url: '/shapes/'+id+'.json',
    type: 'PUT',
    data: { shape: {name: name, xmldata: xml } },
    success: function(data) {
      alert("" + data);
      }
  });
}

function saveDefine(name){
  var xml = getXML();
  jQuery.ajax({
    url: '/shapes.json',
    type: 'POST',
    data: {shape: {name: name, xmldata: xml } },
    success: function(data) {
      alert("" + data);
      }
  });
}

function saveCode(name,saveType) {
  if(!name)
    name = 'autosave';
  if(!saveType) 
    saveType = 'workspace'; // otherwise, it could be a definition (e.g. define cube)
  console.log("saveCode(name=",name,"saveType=",saveType,")");
  var code = getXML();//Blockly.Generator.workspaceToCode('JavaScript');
  jQuery.post(storageApiEndpoint, { shape: {name: name, xmldata: code} })
.done(function(data) {
  alert("" + data);
});
}

function loadMatches(type) {
  if(!type) 
    type = 'shapes';
  //first load shapes
  jQuery.get('/'+type+'/all.json', { },
    function(data){
        var shapeArr = [];
        try {
          // defines = data.global_defines;
          for(defName in data) {
            // console.log('loadShapes('+type+'):',data[defName]);
            matchPhrases[data[defName].name] = data[defName];
            shapeArr.push(data[defName].name);
          }
        } catch (e) {
          alert("Error loading "+type+" data.");
          return;
        }
      console.log('loadShapes('+type+'): '+shapeArr.join(', ')+':',data);
      // window.setTimeout('autoSave = '+tmpAutosave+';',1000);
    }, "json");
}

function loadCode(initialLoad,name,loadType) {
      console.log('loadCode()');
  // var tmpAutosave = autoSave;
  // autoSave = false;
  if(!name)
    name = 'autosave';
  if(!loadType) 
    loadType = 'workspace'; // otherwise, it could be a definition (e.g. define cube)
  if(initialLoad) 
    autoSave = autoSaveInitial;
  jQuery.get('/shapes/all.json', { "loadData": "1", type: loadType, name: name },
    function(data){
      console.log(data);
      // Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, data.data);  
      if(loadType == 'workspace') {
        console.log(data.data); 
        try {
          var xml = Blockly.Xml.textToDom(data.data);
        } catch (e) {
          alert("Error loading blocks.");
          return;
        }
        Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
      }
      // window.setTimeout('autoSave = '+tmpAutosave+';',1000);
    }, "json");
}
var defines = {};
function loadInitial() {
  console.log('loadInitial()');
  jQuery.post(storageApiEndpoint, { initialLoad: '1' },
    function(data){
      console.log('loadInitial():',data);
        try {
          // defines = data.global_defines;
          for(defName in data.global_defines) {
            console.log('loadInitial():',defName);
            matchPhrases[defName] = data.global_defines[defName];
          }
          // var xml = Blockly.Xml.textToDom(data.data);
        } catch (e) {
          alert("Error loading initial data.");
          return;
        }
      // window.setTimeout('autoSave = '+tmpAutosave+';',1000);
    }, "json");
}

function changeAutoSave(changeTo) {
  autoSave = (changeTo == '1');
}

/* depricated
function runMe() {
  return false;
  window.LoopTrap = 1000;
  Blockly.JavaScript.INFINITE_LOOP_TRAP = 'if(--window.LoopTrap == 0) throw "Infinite loop.";\n';
  var code = Blockly.Generator.workspaceToCode('JavaScript');
  alert(code);
  Blockly.JavaScript.addReservedWords('code');
  var code = Blockly.Generator.workspaceToCode('JavaScript');
  try {
    eval(code);
  } catch (e) {
    alert(e);
  }
}
*/

function blockIsSelected(block,typeOfCheck) {
  var isSelected = false;
  // if(block.id && Blockly.selected) console.log("checking if block (id="+block.id+",type="+block.type+') is selected (id='+Blockly.selected.id+',type='+Blockly.selected.type+').');
  // if(!typeOfCheck) typeOfCheck = 'direct';
  if(!Blockly.selected) return false; // no selection
  if(Blockly.selected.id == block.id) {
    // console.log("this is the selected block!!!");
    return true;//isSelected = true;
  }
  if(blockIsShape(Blockly.selected) && (block.id != Blockly.selected.id)) // this is not the shape we're looking for...
  {
    // console.log("isShape? "+blockIsShape(block)+" -- not bubbling up, this isn.t the shape we're looking for.");
    return false; // don't bubble up if we have a different shape selected

  }

  if(typeOfCheck == 'bubbletoshape') {
    // console.log({a:"checking if it's a shape, otherwise go to parent.",sel:Blockly.selected});
    var o = Blockly.selected;
    while(o.parentBlock_) { // as long as it has a parent...
      if(blockIsShape(o.parentBlock_)) { // check if it's a shape.
      // console.log('block id '+o.id,' in category',o.parentBlock_.category,o.category == ucfirst(LANG.shape));
      if(block.id == o.parentBlock_.id)
        return true;
      }
      if(blockIsShape(o.parentBlock_)) // it's an unselected shape. Stop looking.
        return false;
      // it's not the chosen one, bubble up one level:
      // console.log('bubbling up a level (not a selected shape)');
      o = o.parentBlock_;
    }
  }
  return isSelected;
}

function blockIsShape (o) {
  if(!o) return false;
  if(o.category && (o.category == ucfirst(LANG.shape))) return true;
  if(o.type && (o.type == "polygons_extrude")) return true;
  if(o.type && (o.type == "assembly_part")) return true;
  return false;
}

function clearWorkspace() {
  // Blockly.mainWorkspace.getTopBlocks(false)[0].dispose();
  // FIXME: shouldn't have to clear twice.
  var n=0;
  while(typeof Blockly.mainWorkspace.getTopBlocks(false) !='undefined') {
    n++;
    if(n>10) 
      break;
    if(typeof Blockly.mainWorkspace.getTopBlocks(false)[0] !='undefined')
      Blockly.mainWorkspace.getTopBlocks(false)[0].dispose();
  }
}

function var_to_number(varStr){
 return (1*varStr.substring(1,varStr.length-1));
}


$(window).resize(function() {
  $('#blockly').css('top',$(window).height()-115);
  $('#blockly').css('height',360);
  $('#blockly').css('right',$(window).width());
  // $('#blockly').css('width',$(window).width()-20);
  // $('#blockly.modal').css('width','');
  // $('#blockly').css('left',$(window).width()/2-100);
  $('#blockly').css('width',$(window).width()-20);
  // $('#blockly').css('width',$(window).width()-40);
  $('#qsResults').css('left',$('#quickSearchDiv').position().left);
  if (navigator.userAgent.indexOf("Firefox")!=-1) 
    // $('#blockly').css('top',$(window).height()-$('#blockly').height()/2+500);
    $('#blockly').css('top',$(document).height()-$('#blockly').height()/2+60);
});

  </script>
  <style>
    body {
      background-color: white;
      font-family: sans-serif;
    }
    #blockly {top:750px;width: 500px;height:300px;
      left: 287px;

      position: absolute;}

    #inputModal {top:350px;width: 380px;height: 180px;
      left: 287px;
      position: absolute;}
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    #svgDiv {
      height: 280px;
      width: 95%;
      border: 1px solid #ccc;
    }
    .hide {
      display:none;
    }
    #qsResults {
      z-index: 99;
      top: 27px;
      left:180px;
      position: absolute;
      background-color: #fff;
      border: 1px #aaa solid;
      border-radius: 4px;
      padding: 4px;
    }
    .qsItem {
      background-color: white;
      width: 100%;
      cursor: hand;
      min-width: 240px;
    }
    .qsSelected {
      color: white;
      background-color: blue;
    }
    #langDropdown {width: 100px; position: fixed; top:30px;right:200px}
/* flags from http://flag-sprites.com/ */
.flag {width: 16px; height: 11px;background:url(flags.png) no-repeat}
.flag.flag-ch {background-position: -16px 0}
.flag.flag-de {background-position: -32px 0}
.flag.flag-dk {background-position: -48px 0}
.flag.flag-es {background-position: 0 -11px}
.flag.flag-fi {background-position: -16px -11px}
.flag.flag-fr {background-position: -32px -11px}
.flag.flag-gb {background-position: -48px -11px}
.flag.flag-it {background-position: 0 -22px}
.flag.flag-nl {background-position: -16px -22px}
.flag.flag-no {background-position: -32px -22px}
.flag.flag-pt {background-position: -48px -22px}
#jqDialog { 
  display:none;
}
  </style>
</head>
<body onload="init()">
<div class="container-fluid ui-layout-center">
                <div class="row-fluid">
                        <div class="span12">
                                <div id="navigation">
                                </div>
                                <div id="mainContent" class="row-fluid " >
                                </div>
                        </div>
                </div>
        </div>
        <div id="modal" class="modal hide fade">        
        </div>
        <div id="alertmodal" class="modal hide fade">   </div>
        <div id="dialogRegion">
        </div>
        <select id="langDropdown">
          <option value="EN_EN">English</option>
          <option value="DE_DE">German</option>
          <option value="NL_NL">Dutch</option>
        </select>

  <div id="blockly" class="modal">
  <table style="width:100%">
    <tr>
      <td><h5><b>Drag-and-Drop 3D Design</b></h5></td>
      <td><div id="quickSearchDiv"><input type="text" style="color: grey;" title="Quick commands (/)" value="Quick commands (/)" autocomplete="off" onfocus="if(this.value=='Quick commands (/)'){this.value='';$(this).css('color','black');}" onblur="if(this.value==''){this.value='Quick commands (/)';$(this).css('color','grey');}"></div><div id="qsResults"></div></td>
      <td style="padding: 3px; text-align: right;"><a href="#" title="close" onclick="$('#blockly').hide();">x</a></td>
    </tr>
  </table>

  <div id="svgDiv" style="width: 100%"></div>
  <textarea id="codearea" rows=10 style="width:500px" class="hide"></textarea>
  <table><tr><td>
<!--  <select id="lang" onchange="myUpdateFunction();">
    <option value="coffeescad0.1">CoffeeSCAD</option>
    <option value="vol0.1">Uformia .vol</option>
    <option value="scad">OpenSCAD</option>
  </select>
-->
  <!--<input type="button" onclick="runMe();" value="Run!">-->
  <!--<input type="button" onclick="getXML();" value="Get blocky XML!">-->
  <input type="button" onclick="if(typeof hist !='undefined') hist.undo();" value="Undo">
  <input type="button" onclick="if(typeof hist !='undefined') hist.redo();" value="Redo">
  <input type="button" onclick="saveCode();" value="Save!">
  <input type="button" onclick="loadCode();" value="Load!"><label></td><td><input type="checkbox" onclick="changeAutoSave(this.checked);" value="1" checked> Autosave</label></td></tr></table>
</div>
<div id="inputModal" class="modal hide">
<table style="width:100%">
    <tr>
      <td><h5><b>Inputs</b></h5></td>
      <td style="padding: 3px;text-align: right;"><a href="#" title="close" onclick="$('#inputModal').hide();">x</a></td>
    </tr>
  </table>
  <embed id="inputPane" src="assets/plane.svg" height=140 width=380 type="image/svg+xml"/>
</div>
<div id="jqDialog" title="Dialog Title">
  <p><span class="ui-icon ui-icon-alert" style="float: left; margin: 0 7px 20px 0;"></span>Your canvas will be cleared. Are you sure?</p>
</div>
</body>
</html>
