// Generated by CoffeeScript 1.6.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(function(require) {
  var $, Backbone, DialogView, ExternalEditor, ExternalEditorRouter, ExternalEditorSettings, ExternalEditorSettingsView, ExternalEditorView, Project, marionette, reqRes, vent, _;
  $ = require('jquery');
  _ = require('underscore');
  Backbone = require('backbone');
  marionette = require('marionette');
  vent = require('core/messaging/appVent');
  reqRes = require('core/messaging/appReqRes');
  Project = require('core/projects/project');
  ExternalEditorSettings = require('./externalEditorSettings');
  ExternalEditorSettingsView = require('./externalEditorSettingsView');
  ExternalEditorRouter = require("./externalEditorRouter");
  ExternalEditorView = require('./externalEditorView');
  DialogView = require('core/utils/dialogView');
  ExternalEditor = (function(_super) {
    __extends(ExternalEditor, _super);

    ExternalEditor.prototype.title = "ExternalEditor";

    function ExternalEditor(options) {
      this.loadData = __bind(this.loadData, this);
      this.resetEditor = __bind(this.resetEditor, this);
      this.setSketchNeedsReload = __bind(this.setSketchNeedsReload, this);
      this.hideView = __bind(this.hideView, this);
      this.showView = __bind(this.showView, this);
      this.onStart = __bind(this.onStart, this);
      this.init = __bind(this.init, this);
      var _ref, _ref1, _ref2, _ref3;
      ExternalEditor.__super__.constructor.call(this, options);
      this.appSettings = (_ref = options.appSettings) != null ? _ref : null;
      this.settings = (_ref1 = options.settings) != null ? _ref1 : new ExternalEditorSettings();
      this.project = (_ref2 = options.project) != null ? _ref2 : new Project();
      this.vent = vent;
      this.router = new ExternalEditorRouter({
        controller: this
      });
      this.startWithParent = true;
      this.showOnAppStart = false;
      this.addMainMenuIcon = false;
      this.sketchNeedsReload = true;
      this.icon = "icon-th-large";
      this.myTitle = (_ref3 = options.title) != null ? _ref3 : 'External Editor';
      this.vent.on("project:loaded", this.resetEditor);
      this.vent.on("project:created", this.resetEditor);
      this.vent.on("ExternalEditor:show", this.showView);
      this.vent.on("ExternalEditor:hide", this.hideView);
      this.vent.on("ExternalEditor:sketchNeedsReload", this.setSketchNeedsReload);
      this.init();
    }

    ExternalEditor.prototype.init = function() {
      if (this.appSettings != null) {
        this.appSettings.registerSettingClass("ExternalEditor", ExternalEditorSettings);
      }
      this.addInitializer(function() {
        return this.vent.trigger("app:started", "" + this.title, this);
      });
      console.log("app:started " + this.title);
      return reqRes.addHandler("ExternalEditorSettingsView", function() {
        return ExternalEditorSettingsView;
      });
    };

    ExternalEditor.prototype.onStart = function() {
      this.settings = this.appSettings.get("ExternalEditor");
      if (this.showOnAppStart) {
        return this.showView();
      }
    };

    ExternalEditor.prototype.showView = function() {
      if (this.dia == null) {
        this.dia = new DialogView({
          elName: "externalEditor",
          title: this.myTitle,
          width: 300,
          height: 300,
          position: [525, 25],
          dockable: true
        });
        this.dia.render();
      }
      if (this.externalEditorView == null) {
        this.externalEditorView = new ExternalEditorView({
          model: this.project,
          settings: this.settings
        });
      }
      if (this.dia.currentView == null) {
        this.dia.show(this.externalEditorView);
      } else {
        this.dia.showDialog();
      }
      return this.loadData();
    };

    ExternalEditor.prototype.hideView = function() {
      if (this.dia) {
        return this.dia.hideDialog();
      }
    };

    ExternalEditor.prototype.setSketchNeedsReload = function() {
      console.log("setting sketchNeedsReload to true");
      return this.sketchNeedsReload = true;
    };

    ExternalEditor.prototype.resetEditor = function(newProject) {
      console.log("resetting external editor");
      this.project = newProject;
      if (this.dia != null) {
        console.log("closing current external editor");
        this.dia.close();
        this.ExternalEditorView = null;
      }
      window.loadData = this.loadData;
      setTimeout(function() {
        try {
          return loadData();
        } catch (_error) {}
      }, 200);
      return this.showView();
    };

    ExternalEditor.prototype.loadData = function() {
      var block, code, inputTitle, uuid, _i, _input, _len, _ref, _results;
      console.log('externalEditor:loadData() e.g. for loading a sketchs path');
      if (this.sketchNeedsReload === false) {
        return;
      }
      console.log("sketchNeedsReload is true, loading of data from blocks.");
      _ref = Blockly.mainWorkspace.getAllBlocks();
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        block = _ref[_i];
        if (block.type && block.type === "polygons_sketch") {
          _results.push((function() {
            var _j, _k, _len1, _len2, _ref1, _ref2, _results1;
            _ref1 = block.inputList;
            _results1 = [];
            for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
              _input = _ref1[_j];
              _ref2 = _input.titleRow;
              for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
                inputTitle = _ref2[_k];
                if (inputTitle.name === "code") {
                  code = inputTitle.text_;
                }
                if (inputTitle.name === "uuid") {
                  uuid = inputTitle.text_;
                }
              }
              if (code && uuid) {
                console.log("Found both uuid " + uuid + " and the code (" + code + ") for a sketch.");
              }
              $("#exportArea", frames['externalEditor'].document).val(code);
              if (frames['externalEditor'].loadCode) {
                frames['externalEditor'].loadCode();
                _results1.push(this.sketchNeedsReload = false);
              } else {
                _results1.push(void 0);
              }
            }
            return _results1;
          }).call(this));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    return ExternalEditor;

  })(Backbone.Marionette.Application);
  return ExternalEditor;
});
