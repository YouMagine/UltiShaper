// Generated by CoffeeScript 1.6.2
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(function(require) {
  var $, Backbone, BlocklyEditor, BlocklyEditorRouter, BlocklyEditorSettings, BlocklyEditorSettingsView, BlocklyEditorView, DialogView, Project, marionette, reqRes, vent, _;

  $ = require('jquery');
  _ = require('underscore');
  Backbone = require('backbone');
  marionette = require('marionette');
  vent = require('core/messaging/appVent');
  reqRes = require('core/messaging/appReqRes');
  Project = require('core/projects/project');
  BlocklyEditorSettings = require('./blocklyEditorSettings');
  BlocklyEditorSettingsView = require('./blocklyEditorSettingsView');
  BlocklyEditorRouter = require("./blocklyEditorRouter");
  BlocklyEditorView = require('./blocklyEditorView');
  DialogView = require('core/utils/dialogView');
  BlocklyEditor = (function(_super) {
    __extends(BlocklyEditor, _super);

    BlocklyEditor.prototype.title = "BlocklyEditor";

    function BlocklyEditor(options) {
      this.loadBlocks = __bind(this.loadBlocks, this);
      this.resetEditor = __bind(this.resetEditor, this);
      this.hideView = __bind(this.hideView, this);
      this.showView = __bind(this.showView, this);
      this.onStart = __bind(this.onStart, this);
      this.init = __bind(this.init, this);
      var _ref, _ref1, _ref2;

      BlocklyEditor.__super__.constructor.call(this, options);
      this.appSettings = (_ref = options.appSettings) != null ? _ref : null;
      this.settings = (_ref1 = options.settings) != null ? _ref1 : new BlocklyEditorSettings();
      this.project = (_ref2 = options.project) != null ? _ref2 : new Project();
      this.vent = vent;
      this.router = new BlocklyEditorRouter({
        controller: this
      });
      this.startWithParent = true;
      this.showOnAppStart = true;
      this.addMainMenuIcon = true;
      this.icon = "icon-th-large";
      this.vent.on("project:loaded", this.resetEditor);
      this.vent.on("project:created", this.resetEditor);
      this.vent.on("blocklyEditor:show", this.showView);
      this.init();
    }

    BlocklyEditor.prototype.init = function() {
      if (this.appSettings != null) {
        this.appSettings.registerSettingClass("BlocklyEditor", BlocklyEditorSettings);
      }
      this.loadBlocks();
      this.addInitializer(function() {
        return this.vent.trigger("app:started", "" + this.title, this);
      });
      console.log("app:started " + this.title);
      return reqRes.addHandler("BlocklyEditorSettingsView", function() {
        return BlocklyEditorSettingsView;
      });
    };

    BlocklyEditor.prototype.onStart = function() {
      this.settings = this.appSettings.get("BlocklyEditor");
      return this.showView();
    };

    BlocklyEditor.prototype.showView = function() {
      if (this.dia == null) {
        this.dia = new DialogView({
          elName: "blocklyEdit",
          title: "Drag-and-Drop 3D design",
          width: 500,
          height: 200,
          position: [25, 25],
          dockable: true
        });
        this.dia.render();
      }
      if (this.blocklyEditorView == null) {
        this.blocklyEditorView = new BlocklyEditorView({
          model: this.project,
          settings: this.settings
        });
      }
      if (this.dia.currentView == null) {
        return this.dia.show(this.blocklyEditorView);
      } else {
        return this.dia.showDialog();
      }
    };

    BlocklyEditor.prototype.hideView = function() {
      return this.dia.hideDialog();
    };

    BlocklyEditor.prototype.resetEditor = function(newProject) {
      console.log("resetting Blockly editor");
      this.project = newProject;
      if (this.dia != null) {
        console.log("closing current Blockly editor");
        this.dia.close();
        this.blocklyEditorView = null;
      }
      this.loadBlocks();
      return this.showView();
    };

    BlocklyEditor.prototype.loadBlocks = function() {
      var ext, fileParts, model, modelId, _i, _len, _ref, _results;

      console.log('-----------------=================----------------');
      _ref = this.project.rootFolder.models;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        model = _ref[_i];
        fileParts = model.id.split('.');
        ext = fileParts[fileParts.length - 1];
        modelId = fileParts[0];
        if (modelId === this.project.id) {
          window.xmlStr = model.storedContent;
          _results.push(setTimeout(function() {
            var xml;

            try {
              xml = Blockly.Xml.textToDom(window.xmlStr);
              return Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
            } catch (_error) {}
          }, 10));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    return BlocklyEditor;

  })(Backbone.Marionette.Application);
  return BlocklyEditor;
});
